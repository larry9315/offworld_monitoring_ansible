---
- name: Ensure offworld-admin user exists
  ansible.builtin.user:
    name: "{{ offworld_admin_username }}"
    shell: "{{ offworld_admin_shell }}"
    create_home: yes
    password: "{{ offworld_admin_password | password_hash('sha512') }}"
    groups: "sudo"
    append: yes

- name: Allow offworld-admin passwordless sudo
  ansible.builtin.copy:
    dest: "/etc/sudoers.d/{{ offworld_admin_username }}"
    content: "{{ offworld_admin_username }} ALL=(ALL) NOPASSWD:ALL\n"
    owner: root
    group: root
    mode: "0440"

- name: Ensure .ssh directory exists for offworld-admin
  ansible.builtin.file:
    path: "/home/{{ offworld_admin_username }}/.ssh"
    state: directory
    owner: "{{ offworld_admin_username }}"
    group: "{{ offworld_admin_username }}"
    mode: "0700"

- name: Install authorized keys for offworld-admin
  ansible.builtin.authorized_key:
    user: "{{ offworld_admin_username }}"
    state: present
    key: "{{ item }}"
  loop: "{{ offworld_admin_authorized_keys }}"
